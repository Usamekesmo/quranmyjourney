// main.js - ุงููุณุฎุฉ ุงูููุงุฆูุฉ ูุน ุฌููุน ุฃููุงุน ุงูุงุฎุชุจุงุฑุงุช ุงูุฌุฏูุฏุฉ

const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_3Q0Vib_WaJQT_pzesr2yn_sw-hsuwpqJN2g3iBuJVSXZlkq5AyXq5LudmCEie-K3LA/exec';
let currentUser = null;

// --- ุฏูุงู ุนุงูุฉ ูุชุงุญุฉ ูููููุงุช ุงูุฃุฎุฑู ---
async function addXP(points) {
    if (!currentUser || points === 0) return;
    currentUser.xp += points;
    updateGamificationUI(currentUser);
    
    try {
        const { level, stage } = calculateLevelAndStage(currentUser.xp);
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', 'updateUserData');
        url.searchParams.append('userId', currentUser.userId);
        url.searchParams.append('xp', currentUser.xp);
        url.searchParams.append('level', level);
        url.searchParams.append('stage', stage);
        url.searchParams.append('testedPages', JSON.stringify(currentUser.testedPages || []));

        const response = await fetch(url);
        const result = await response.json();
        if (result.success) console.log("User data updated.");
    } catch (error) {
        console.error('Failed to update user data:', error);
    }
}

function updateGamificationUI(user) {
    const { stage, level, xpForNextLevel, progressXP, baseXPForLevel } = calculateLevelAndStage(user.xp);
    document.getElementById('userTitle').textContent = getTitle(stage, level);
    document.getElementById('userXP').textContent = user.xp;
    document.getElementById('userLevel').textContent = `${level} / ${STAGES[stage].levels}`;
    
    const progressPercentage = (progressXP / baseXPForLevel) * 100;
    const progressBar = document.getElementById('levelProgress');
    progressBar.style.width = `${progressPercentage}%`;
    progressBar.textContent = `${Math.round(progressPercentage)}%`;
    
    document.getElementById('progressText').textContent = (xpForNextLevel === Infinity) ?
        'ููุฏ ูุตูุช ุฅูู ุฃุนูู ูุณุชูู!' : `ุงูููุงุท ุงููุทููุจุฉ ูููุณุชูู ุงูุชุงูู: ${xpForNextLevel}`;
    
    // ุชุญุฏูุซ ุนุฑุถ ุงูุฌูุงูุฑ
    const gemsElement = document.getElementById('userGems');
    if (gemsElement) {
        gemsElement.textContent = `${user.gems || 0} ๐`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // --- ูุชุบูุฑุงุช ุญุงูุฉ ุงูุงุฎุชุจุงุฑ ---
    let allAyahs = [];
    let score = 0;
    let questionsAsked = 0;
    let totalQuestions = 5;
    let testedScope = [];
    let perfectStreak = 0; // ูุชุบูุฑ ูุชุชุจุน ุณูุณูุฉ ุงููุฌุงุญ ุงููุซุงููุฉ
    
    const reciters = {
        "ar.alafasy": "ูุดุงุฑู ุฑุงุดุฏ ุงูุนูุงุณู", 
        "ar.abdulsamad": "ุนุจุฏ ุงูุจุงุณุท ุนุจุฏ ุงูุตูุฏ", 
        "ar.sudais": "ุนุจุฏ ุงูุฑุญูู ุงูุณุฏูุณ",
        "ar.mahermuaiqly": "ูุงูุฑ ุงููุนูููู", 
        "ar.minshawi": "ูุญูุฏ ุตุฏูู ุงูููุดุงูู"
    };

    // --- ุนูุงุตุฑ ุงููุงุฌูุฉ ---
    const loginSection = document.getElementById('loginSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const profileSection = document.getElementById('profileSection');
    const quizArea = document.getElementById('quizArea');
    const resultsSection = document.getElementById('resultsSection');
    const storeSection = document.getElementById('storeSection');
    const loginBtn = document.getElementById('loginBtn');
    const fullNameInput = document.getElementById('fullNameInput');
    const nameError = document.getElementById('nameError');
    const startTestBtn = document.getElementById('startTestBtn');
    const backToDashboardBtn = document.getElementById('backToDashboardBtn');
    const profileBtn = document.getElementById('profileBtn');
    const storeBtn = document.getElementById('storeBtn');
    const backToDashboardFromProfileBtn = document.getElementById('backToDashboardFromProfileBtn');
    const backToDashboardFromStoreBtn = document.getElementById('backToDashboardFromStoreBtn');
    const challengesContainer = document.getElementById('challengesContainer');
    const quranGrid = document.getElementById('quran-grid');
    const loader = document.getElementById('loader');
    const quizContent = document.getElementById('quizContent');
    const questionText = document.getElementById('questionText');
    const audioPlayer = document.getElementById('audioPlayer');
    const answerContainer = document.getElementById('answer-container');
    const resultMessage = document.getElementById('resultMessage');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');

    // --- ุฑุจุท ุงูุฃุญุฏุงุซ ---
    loginBtn.addEventListener('click', handleLogin);
    startTestBtn.addEventListener('click', startTest);
    backToDashboardBtn.addEventListener('click', handleBackToDashboard);
    profileBtn.addEventListener('click', showProfile);
    if (storeBtn) storeBtn.addEventListener('click', showStore);
    backToDashboardFromProfileBtn.addEventListener('click', handleBackToDashboard);
    if (backToDashboardFromStoreBtn) backToDashboardFromStoreBtn.addEventListener('click', handleBackToDashboard);
    nextQuestionBtn.addEventListener('click', nextQuestion);

    // --- ุงูุฏูุงู ุงูุฑุฆูุณูุฉ ---
    async function handleLogin() {
        const fullName = fullNameInput.value.trim();
        if (fullName.length > 20 || fullName.split(' ').length < 2) {
            nameError.classList.remove('hidden');
            return;
        }
        nameError.classList.add('hidden');
        loginBtn.disabled = true;
        loginBtn.textContent = 'ุฌุงุฑู ุงูุฏุฎูู...';

        try {
            const url = new URL(GOOGLE_SCRIPT_URL);
            url.searchParams.append('action', 'getUserData');
            url.searchParams.append('userId', fullName);
            url.searchParams.append('fullName', fullName);
            
            const response = await fetch(url);
            const result = await response.json();
            
            if (!result.success || !result.data) throw new Error(result.error || "ุจูุงูุงุช ุงูุฎุงุฏู ุบูุฑ ุตุงูุญุฉ.");
            
            currentUser = result.data;
            
            // ุชููุฆุฉ ูุธุงู ุงูุฌูุงูุฑ
            await initializeGemsSystem();
            
            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            updateUI(currentUser);
        } catch (error) {
            alert(`ูุดู ุชุณุฌูู ุงูุฏุฎูู: ${error.message}`);
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = 'ุฏุฎูู / ุฅูุดุงุก ุญุณุงุจ';
        }
    }

    function handleBackToDashboard() {
        resultsSection.classList.add('hidden');
        profileSection.classList.add('hidden');
        if (storeSection) storeSection.classList.add('hidden');
        dashboardSection.classList.remove('hidden');
        updateUI(currentUser);
    }

    function updateUI(user) {
        if (!user) return;
        document.getElementById('welcomeMessage').textContent = `ูุฑุญุจุงู ูุง ${user.fullName}!`;
        updateGamificationUI(user);
        updateTestSelectionUI(user);
        displayChallenges(user, challengesContainer);
    }

    function updateTestSelectionUI(user) {
        const { stage } = calculateLevelAndStage(user.xp);
        const stageInfo = STAGES[stage];
        const testOptionsContainer = document.getElementById('testOptionsContainer');
        const scopeContainer = document.getElementById('scopeSelectionContainer');
        const stageTitleElement = document.getElementById('stageTitle');

        if (!testOptionsContainer || !scopeContainer || !stageTitleElement) {
            console.error("Critical UI elements are missing.");
            return;
        }

        let optionsHtml = '', scopeHtml = '';
        stageTitleElement.textContent = `ุฃูุช ูู ุงููุฑุญูุฉ ${stage}: ${stageInfo.name}.`;

        // ุญุณุงุจ ุนุฏุฏ ุงูุฃุณุฆูุฉ ูุน ูุฑุงุนุงุฉ ุงูููุชุฌุงุช ุงููุดุชุฑุงุฉ
        let questionsCount = Math.min(15, 5 * stage);
        const extraQuestions = getPurchasedItemsByCategory('questions');
        if (extraQuestions.length > 0) {
            questionsCount += extraQuestions.length * 5;
        }

        // ุญุณุงุจ ุงููุฑุงุก ุงููุชุงุญูู ูุน ูุฑุงุนุงุฉ ุงูููุชุฌุงุช ุงููุดุชุฑุงุฉ
        let availableRecitersCount = Math.min(Object.keys(reciters).length, stage);
        const extraReciters = getPurchasedItemsByCategory('reciters');
        availableRecitersCount += extraReciters.length;

        optionsHtml += `<label for="numQuestions">ุนุฏุฏ ุงูุฃุณุฆูุฉ:</label><input type="number" id="numQuestions" value="${questionsCount}" min="${5 * stage}" max="${questionsCount}">`;
        optionsHtml += `<label for="reciter">ุงุฎุชุฑ ุงูุดูุฎ:</label><select id="reciter">`;
        
        const allReciters = Object.entries(reciters);
        for (let i = 0; i < Math.min(availableRecitersCount, allReciters.length); i++) {
            const [id, name] = allReciters[i];
            optionsHtml += `<option value="${id}">${name}</option>`;
        }
        optionsHtml += `</select>`;
        testOptionsContainer.innerHTML = optionsHtml;

        // ููุทู ุงุฎุชูุงุฑ ุงููุทุงู
        switch (stage) {
            case 1:
                scopeHtml = `<p>ูู ูุฐู ุงููุฑุญูุฉุ ููููู ุงูุงุฎุชุจุงุฑ ูู ุตูุญุฉ ูุงุญุฏุฉ ููุท.</p><label for="pageNumber">ุงุฎุชุฑ ุฑูู ุงูุตูุญุฉ (1 - 604):</label><input type="number" id="pageNumber" min="1" max="604" value="1">`;
                break;
            case 2: case 3: case 4:
                scopeHtml = `<p>ุฃุญุณูุช! ููููู ุงูุขู ุงูุงุฎุชุจุงุฑ ูู ูุทุงู ูู <strong>${stage} ุตูุญุงุช ูุชุชุงููุฉ</strong>.</p><label for="startPage">ุงุฎุชุฑ ุตูุญุฉ ุงูุจุฏุงูุฉ:</label><input type="number" id="startPage" min="1" max="${605 - stage}" value="1"><label for="endPage">ุตูุญุฉ ุงูููุงูุฉ (ุชููุงุฆู):</label><input type="number" id="endPage" value="${stage}" readonly style="background-color: #e9ecef;">`;
                break;
            case 5:
                scopeHtml = `<p>ูุจุงุฑู! ููููู ุงูุขู ุงูุงุฎุชุจุงุฑ ูู ูุทุงู ุตูุญุงุชุ ุฃู ุฌุฒุก ูุงููุ ุฃู ุณูุฑุฉ ูุงููุฉ.</p><label for="scopeType">ุงุฎุชุฑ ููุน ุงููุทุงู:</label><select id="scopeType"><option value="range">ูุทุงู ุตูุญุงุช</option><option value="juz">ุฌุฒุก ูุงูู</option><option value="surah">ุณูุฑุฉ ูุงููุฉ</option></select><div id="scopeInputs"></div>`;
                break;
        }
        scopeContainer.innerHTML = scopeHtml;

        if (stage >= 2 && stage <= 4) {
            const startInput = document.getElementById('startPage');
            if (startInput) startInput.addEventListener('input', () => {
                document.getElementById('endPage').value = Math.min(604, (parseInt(startInput.value) || 1) + stage - 1);
            });
        } else if (stage === 5) {
            const scopeTypeSelect = document.getElementById('scopeType');
            if (scopeTypeSelect) {
                scopeTypeSelect.addEventListener('change', handleScopeTypeChange);
                handleScopeTypeChange();
            }
        }
    }

    function handleScopeTypeChange() { 
        // ููุทู ุชุบููุฑ ุงููุทุงู ูู ุงููุฑุญูุฉ 5
    }

    async function startTest() {
        const reciterSelect = document.getElementById('reciter');
        const numQuestionsInput = document.getElementById('numQuestions');
        
        if (!reciterSelect || !numQuestionsInput) {
            alert("ุฎุทุฃ ูู ุงููุงุฌูุฉ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงุตุฑ ุงูุงุฎุชุจุงุฑ. ุงูุฑุฌุงุก ุชุญุฏูุซ ุงูุตูุญุฉ.");
            return;
        }
        
        const selectedReciter = reciterSelect.value;
        totalQuestions = parseInt(numQuestionsInput.value) || 5;
        const { stage } = calculateLevelAndStage(currentUser.xp);
        testedScope = [];
        let apiUrl = '';

        try {
            switch (stage) {
                case 1:
                    const page = document.getElementById('pageNumber').value;
                    apiUrl = `https://api.alquran.cloud/v1/page/${page}/${selectedReciter}`;
                    testedScope.push(parseInt(page));
                    break;
                case 2: case 3: case 4:
                    const startPage = parseInt(document.getElementById('startPage').value);
                    const endPage = parseInt(document.getElementById('endPage').value);
                    apiUrl = { type: 'range', start: startPage, end: endPage, reciter: selectedReciter };
                    for (let i = startPage; i <= endPage; i++) testedScope.push(i);
                    break;
                case 5:
                    // ููุทู ุงููุฑุญูุฉ ุงูุฎุงูุณุฉ
                    break;
            }

            dashboardSection.classList.add('hidden');
            quizArea.classList.remove('hidden');
            loader.classList.remove('hidden');
            quizContent.classList.add('hidden');
            loader.textContent = 'ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงูุขูุงุช...';

            allAyahs = [];
            if (typeof apiUrl === 'string') {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('ูุดู ูู ุฌูุจ ุงูุจูุงูุงุช.');
                const data = await response.json();
                allAyahs = data.data.ayahs;
            } else if (apiUrl.type === 'range') {
                for (let i = apiUrl.start; i <= apiUrl.end; i++) {
                    const response = await fetch(`https://api.alquran.cloud/v1/page/${i}/${apiUrl.reciter}`);
                    if (!response.ok) throw new Error(`ูุดู ุฌูุจ ุตูุญุฉ ${i}`);
                    const data = await response.json();
                    allAyahs.push(...data.data.ayahs);
                }
            }

            if (allAyahs.length < 4) throw new Error('ูุง ููุฌุฏ ุนุฏุฏ ูุงูู ูู ุงูุขูุงุช ูู ูุฐุง ุงููุทุงู.');
            score = 0;
            questionsAsked = 0;
            nextQuestion();
        } catch (error) {
            loader.textContent = `ุฎุทุฃ: ${error.message}`;
            quizArea.innerHTML += `<button class="main-btn" onclick="location.reload()">ุงูุนูุฏุฉ</button>`;
        }
    }

    function nextQuestion() {
        if (questionsAsked >= totalQuestions) {
            showFinalResults();
            return;
        }
        questionsAsked++;
        resetUIForNewQuestion();
        
        // ุงุฎุชูุงุฑ ููุน ุณุคุงู ุจูุงุกู ุนูู ุงูููุชุฌุงุช ุงููุดุชุฑุงุฉ
        const availableQuestionTypes = getAvailableQuestionTypes();
        const type = availableQuestionTypes[Math.floor(Math.random() * availableQuestionTypes.length)];
        
        executeQuestionType(type);
    }

    // ุฏุงูุฉ ููุญุตูู ุนูู ุฃููุงุน ุงูุฃุณุฆูุฉ ุงููุชุงุญุฉ
    function getAvailableQuestionTypes() {
        let types = ['mcq_next_ayah', 'mcq_previous_ayah'];
        
        // ุฅุถุงูุฉ ุฃููุงุน ุฃุณุฆูุฉ ุฌุฏูุฏุฉ ุจูุงุกู ุนูู ุงููุดุชุฑูุงุช
        if (hasUserPurchased('question_type_sequence')) {
            types.push('sequence_ayahs_3', 'sequence_ayahs_4', 'sequence_ayahs_5');
        }
        if (hasUserPurchased('question_type_intruder')) {
            types.push('find_intruder_3', 'find_intruder_4', 'find_intruder_5');
        }
        if (hasUserPurchased('question_type_location')) {
            types.push('ayah_location', 'page_number', 'ayah_number');
        }
        if (hasUserPurchased('question_type_completion')) {
            types.push('complete_ayah_5', 'complete_ayah_4', 'complete_ayah_3', 'complete_ayah_2');
        }
        
        return types;
    }

    // ุฏุงูุฉ ุชูููุฐ ููุน ุงูุณุคุงู ุงููุญุฏุฏ
    function executeQuestionType(type) {
        switch (type) {
            // ุงูุฃููุงุน ุงูุฃุณุงุณูุฉ
            case 'mcq_next_ayah':
                setupMCQ_NextAyah();
                break;
            case 'mcq_previous_ayah':
                setupMCQ_PreviousAyah();
                break;
            
            // ุงุฎุชุจุงุฑุงุช ุชุฑุชูุจ ุงูุขูุงุช
            case 'sequence_ayahs_3':
                setupSequenceAyahs3();
                break;
            case 'sequence_ayahs_4':
                setupSequenceAyahs4();
                break;
            case 'sequence_ayahs_5':
                setupSequenceAyahs5();
                break;
            
            // ุงุฎุชุจุงุฑุงุช ุงูุขูุฉ ุงูุฏุฎููุฉ
            case 'find_intruder_3':
                setupFindIntruder3();
                break;
            case 'find_intruder_4':
                setupFindIntruder4();
                break;
            case 'find_intruder_5':
                setupFindIntruder5();
                break;
            
            // ุงุฎุชุจุงุฑุงุช ุชุญุฏูุฏ ุงููููุน
            case 'ayah_location':
                setupAyahLocation();
                break;
            case 'page_number':
                setupPageNumber();
                break;
            case 'ayah_number':
                setupAyahNumber();
                break;
            
            // ุงุฎุชุจุงุฑุงุช ุฅููุงู ุงูุขูุงุช
            case 'complete_ayah_5':
                setupCompleteAyah5Words();
                break;
            case 'complete_ayah_4':
                setupCompleteAyah4Words();
                break;
            case 'complete_ayah_3':
                setupCompleteAyah3Words();
                break;
            case 'complete_ayah_2':
                setupCompleteAyah2Words();
                break;
            
            default:
                setupMCQ_NextAyah(); // ุงูุงูุชุฑุงุถู
        }
    }

    // ุงูุฏูุงู ุงูุฃุณุงุณูุฉ ููุงุฎุชุจุงุฑุงุช ุงูููุฌูุฏุฉ
    function setupMCQ_NextAyah() {
        questionText.textContent = `ุงูุณุคุงู ${questionsAsked}/${totalQuestions}: ุงุฎุชุฑ ุงูุขูุฉ ุงูุชุงููุฉ:`;
        const questionIndex = Math.floor(Math.random() * (allAyahs.length - 1));
        const questionAyah = allAyahs[questionIndex];
        const correctAnswer = allAyahs[questionIndex + 1];
        audioPlayer.src = questionAyah.audio;
        const wrongChoices = allAyahs.filter(a => a.number !== correctAnswer.number && a.number !== questionAyah.number).sort(() => 0.5 - Math.random()).slice(0, 3);
        createChoiceButtons(shuffleArray([correctAnswer, ...wrongChoices]), correctAnswer);
    }

    function setupMCQ_PreviousAyah() {
        questionText.textContent = `ุงูุณุคุงู ${questionsAsked}/${totalQuestions}: ุงุฎุชุฑ ุงูุขูุฉ ุงูุณุงุจูุฉ:`;
        const questionIndex = Math.floor(Math.random() * (allAyahs.length - 1)) + 1;
        const questionAyah = allAyahs[questionIndex];
        const correctAnswer = allAyahs[questionIndex - 1];
        audioPlayer.src = questionAyah.audio;
        const wrongChoices = allAyahs.filter(a => a.number !== correctAnswer.number && a.number !== questionAyah.number).sort(() => 0.5 - Math.random()).slice(0, 3);
        createChoiceButtons(shuffleArray([correctAnswer, ...wrongChoices]), correctAnswer);
    }

    function createChoiceButtons(choices, correctAnswer) {
        const choicesContainer = document.createElement('div');
        choicesContainer.id = 'choices-container';
        choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'choice-btn ayah-text';
            button.textContent = choice.text;
            button.onclick = () => {
                choicesContainer.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                showResult(choice.number === correctAnswer.number, button, `ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: <div class="ayah-text">${correctAnswer.text}</div>`);
            };
            choicesContainer.appendChild(button);
        });
        answerContainer.appendChild(choicesContainer);
    }

    function showResult(isCorrect, selectedButton, detailedAnswer) {
        if (isCorrect) {
            score++;
            resultMessage.textContent = 'ุฅุฌุงุจุฉ ุตุญูุญุฉ! ุฃุญุณูุช.';
            resultMessage.className = 'resultMessage correct-msg';
            selectedButton.classList.add('correct');
        } else {
            resultMessage.innerHTML = `ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ. ${detailedAnswer}`;
            resultMessage.className = 'resultMessage incorrect-msg';
            selectedButton.classList.add('incorrect');
        }
        resultMessage.classList.remove('hidden');
        nextQuestionBtn.classList.remove('hidden');
    }

    async function showFinalResults() {
        quizArea.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        
        const xpGained = score * 10;
        const isPerfect = (score === totalQuestions);
        
        document.getElementById('finalScore').textContent = `ุฃุญุณูุช! ููุฏ ุฃุฌุจุช ุนูู ${score} ูู ${totalQuestions} ุฃุณุฆูุฉ ุจุดูู ุตุญูุญ.`;
        document.getElementById('xpGained').textContent = `+${xpGained} XP`;
        
        // ูุญุต ุงุณุชุญูุงู ุงูุฌูุงูุฑ
        const gemsEarned = await checkGemsReward(score, totalQuestions, isPerfect && perfectStreak >= 2);
        
        // ุชุญุฏูุซ ุณูุณูุฉ ุงููุฌุงุญ ุงููุซุงููุฉ
        if (isPerfect) {
            perfectStreak++;
        } else {
            perfectStreak = 0;
        }
        
        // ุชูููู ุงูุตูุญุงุช ุนูุฏ ุงููุฌุงุญ
        if (score / totalQuestions >= 0.5) {
            if (!currentUser.testedPages) currentUser.testedPages = [];
            testedScope.forEach(page => {
                if (!currentUser.testedPages.includes(page)) currentUser.testedPages.push(page);
            });
        }
        
        await addXP(xpGained);
        await checkDailyChallengeProgress(testedScope[0], currentUser);
        
        // ุนุฑุถ ูุนูููุงุช ุงูุฌูุงูุฑ ุงูููุชุณุจุฉ
        if (gemsEarned > 0) {
            const gemsInfo = document.createElement('p');
            gemsInfo.className = 'gems-gain';
            gemsInfo.textContent = `+${gemsEarned} ๐`;
            gemsInfo.style.cssText = 'color: #ffc107; font-size: 1.5em; font-weight: bold; text-align: center; margin-top: 10px;';
            document.getElementById('xpGained').parentNode.insertBefore(gemsInfo, document.getElementById('xpGained').nextSibling);
        }
    }

    function resetUIForNewQuestion() {
        loader.classList.add('hidden');
        quizContent.classList.remove('hidden');
        resultMessage.classList.add('hidden');
        nextQuestionBtn.classList.add('hidden');
        answerContainer.innerHTML = '';
        audioPlayer.src = '';
    }

    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function showProfile() {
        dashboardSection.classList.add('hidden');
        profileSection.classList.remove('hidden');
        updateProfileUI();
    }

    function showStore() {
        dashboardSection.classList.add('hidden');
        if (storeSection) {
            storeSection.classList.remove('hidden');
            updateStoreUI();
        }
    }

    function updateProfileUI() {
        if (!currentUser) return;
        const { stage, level } = calculateLevelAndStage(currentUser.xp);
        document.getElementById('profileUserTitle').textContent = getTitle(stage, level);
        document.getElementById('profileUserXP').textContent = currentUser.xp;
        document.getElementById('profileUserStage').textContent = `${stage}: ${STAGES[stage].name}`;
        
        // ุชุญุฏูุซ ุดุฌุฑุฉ ุงูุญูุธ
        if (quranGrid) {
            quranGrid.innerHTML = '';
            for (let page = 1; page <= 604; page++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'grid-page';
                pageDiv.textContent = page;
                
                if (currentUser.testedPages && currentUser.testedPages.includes(page)) {
                    pageDiv.classList.add('tested');
                } else {
                    pageDiv.classList.add('not-tested');
                }
                
                quranGrid.appendChild(pageDiv);
            }
        }
    }
});

