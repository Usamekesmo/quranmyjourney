<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุงุฎุชุจุงุฑ ุงูุชูุงุนูู ูููุฑุขู ุงููุฑูู - ุงููุณุฎุฉ ุงููุทูุฑุฉ ูุน ูุธุงู ุงูุฌูุงูุฑ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <!-- 1. ูุณู ุชุณุฌูู ุงูุฏุฎูู -->
        <div id="loginSection">
            <h1>ูุฑุญุจุงู ุจู ูู ุงูุงุฎุชุจุงุฑ ุงูุชูุงุนูู ูููุฑุขู ุงููุฑูู</h1>
            <p>ุงุฏุฎู ุงุณูู ุงูุซูุงุซู (20 ุญุฑูุงู ูุญุฏ ุฃูุตู) ูุจุฏุก ุฑุญูุชู ูู ุญูุธ ูุชุงุจ ุงููู.</p>
            <input type="text" id="fullNameInput" placeholder="ูุซุงู: ุนุจุฏ ุงููู ุจู ุนูุฑ">
            <p id="nameError" class="error-message hidden">ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุซูุงุซู ุตุญูุญ ูุง ูุชุฌุงูุฒ 20 ุญุฑูุงู.</p>
            <button id="loginBtn" class="main-btn">ุฏุฎูู / ุฅูุดุงุก ุญุณุงุจ</button>
        </div>

        <!-- 2. ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ (Dashboard) -->
        <div id="dashboardSection" class="hidden">
            <div class="header-flex">
                <h2 id="welcomeMessage"></h2>
                <div class="header-buttons">
                    <button id="storeBtn" class="secondary-btn">๐ ุงููุชุฌุฑ</button>
                    <button id="profileBtn" class="secondary-btn">ูููู ุงูุดุฎุตู</button>
                </div>
            </div>
            
            <div class="gamification-stats">
                <div class="stat-card">
                    <div class="stat-title">ุงูููุจ</div>
                    <div id="userTitle" class="stat-value"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ุงูููุงุท (XP)</div>
                    <div id="userXP" class="stat-value"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ุงููุณุชูู</div>
                    <div id="userLevel" class="stat-value"></div>
                </div>
                <div class="stat-card gems-card">
                    <div class="stat-title">ุงูุฌูุงูุฑ</div>
                    <div id="userGems" class="stat-value gems-value">0 ๐</div>
                </div>
            </div>
            <div class="progress-bar-container">
                <div id="levelProgress" class="progress-bar"></div>
            </div>
            <p id="progressText" class="progress-info"></p>
            <hr>

            <div id="testSelection">
                <h3>ุงุฎุชุฑ ุงุฎุชุจุงุฑู</h3>
                <p id="stageTitle"></p>
                <div id="testOptionsContainer"></div> 
                <div id="scopeSelectionContainer"></div>
                <button id="startTestBtn" class="main-btn">ุจุฏุก ุงูุงุฎุชุจุงุฑ</button>
            </div>
            <hr>

            <div id="challengesSection">
                <h3>ุชุญุฏูุงุช ูุดุทุฉ</h3>
                <div id="challengesContainer"></div>
            </div>
        </div>

        <!-- 3. ูุณู ุงูููู ุงูุดุฎุตู (Profile Section) -->
        <div id="profileSection" class="hidden">
            <div class="header-flex">
                <h2>ุงูููู ุงูุดุฎุตู ูุงูุฅูุฌุงุฒุงุช</h2>
                <button id="backToDashboardFromProfileBtn" class="secondary-btn">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
            </div>
            <div class="gamification-stats">
                <div class="stat-card">
                    <div class="stat-title">ุงูููุจ</div>
                    <div id="profileUserTitle" class="stat-value"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ุฅุฌูุงูู ุงูููุงุท</div>
                    <div id="profileUserXP" class="stat-value"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ุงููุฑุญูุฉ ุงูุญุงููุฉ</div>
                    <div id="profileUserStage" class="stat-value"></div>
                </div>
                <div class="stat-card gems-card">
                    <div class="stat-title">ุฅุฌูุงูู ุงูุฌูุงูุฑ</div>
                    <div class="stat-value gems-value user-gems">0 ๐</div>
                </div>
            </div>
            <hr>
            <h3>ุดุฌุฑุฉ ุงูุญูุธ (ุชูุฏูู ูู ุตูุญุงุช ุงููุฑุขู)</h3>
            <p>ูู ูุฑุจุน ููุซู ุตูุญุฉ ูู ุงููุฑุขู. ูุชู ุชูููู ุงูุตูุญุงุช ุงูุชู ุฃุชููุช ุงุฎุชุจุงุฑูุง ุจูุฌุงุญ.</p>
            <div id="quran-grid-container">
                <div id="quran-grid"></div>
            </div>
            <div class="grid-legend">
                <span><span class="legend-box not-tested"></span> ูู ูุชู ุงุฎุชุจุงุฑูุง</span>
                <span><span class="legend-box tested"></span> ุชู ุงุฎุชุจุงุฑูุง</span>
            </div>
        </div>

        <!-- 4. ูุณู ุงููุชุฌุฑ (Store Section) -->
        <div id="storeSection" class="hidden">
            <div class="header-flex">
                <h2>๐ ูุชุฌุฑ ุงูููุงูุขุช</h2>
                <button id="backToDashboardFromStoreBtn" class="secondary-btn">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
            </div>
            
            <div class="store-balance">
                <div class="balance-card">
                    <span class="balance-label">ุฑุตูุฏู ุงูุญุงูู:</span>
                    <span class="balance-value user-gems">0 ๐</span>
                </div>
            </div>
            
            <div class="store-info">
                <p>๐ฏ ุงุญุตู ุนูู ุงูุฌูุงูุฑ ูู ุฎูุงู:</p>
                <ul>
                    <li>๐ ุฌููุฑุฉ ูุงุญุฏุฉ ููู ุงุฎุชุจุงุฑ ูุซุงูู (100%)</li>
                    <li>๐๐ ุฌููุฑุชุงู ุฅุถุงููุชุงู ูุณูุณูุฉ ุงููุฌุงุญ (3 ุฃูุงู ูุชุชุงููุฉ)</li>
                    <li>๐๐๐ ููุงูุขุช ุฎุงุตุฉ ูุฅุชูุงู ุฃุฌุฒุงุก ูุงููุฉ</li>
                </ul>
            </div>
            
            <div class="store-categories">
                <div class="category-tabs">
                    <button class="category-tab active" data-category="all">ุฌููุน ุงูููุชุฌุงุช</button>
                    <button class="category-tab" data-category="questions">ุฃุณุฆูุฉ ุฅุถุงููุฉ</button>
                    <button class="category-tab" data-category="reciters">ูุฑุงุก ุฌุฏุฏ</button>
                    <button class="category-tab" data-category="question_types">ุฃููุงุน ุฃุณุฆูุฉ</button>
                    <button class="category-tab" data-category="themes">ุงููุธุงูุฑ</button>
                    <button class="category-tab" data-category="boosters">ูุนุฒุฒุงุช</button>
                </div>
            </div>
            
            <div id="storeItemsContainer" class="store-items-grid">
                <!-- ุณูุชู ููุก ุงูููุชุฌุงุช ููุง ุจูุงุณุทุฉ JavaScript -->
            </div>
        </div>

        <!-- 5. ูุณู ุงูุงุฎุชุจุงุฑ (Quiz Area) -->
        <div id="quizArea" class="hidden">
            <div id="loader">ุฌุงุฑู ุชุญุถูุฑ ุงูุณุคุงู...</div>
            <div id="quizContent" class="hidden">
                <p id="questionText"></p>
                <audio id="audioPlayer" controls></audio>
                <div id="answer-container"></div>
                <div id="resultMessage" class="hidden"></div>
                <button id="nextQuestionBtn" class="main-btn hidden">ุงูุณุคุงู ุงูุชุงูู</button>
            </div>
        </div>

        <!-- 6. ูุณู ุงููุชุงุฆุฌ (Results) -->
        <div id="resultsSection" class="hidden">
            <h2>ุงูุชูู ุงูุงุฎุชุจุงุฑ!</h2>
            <p id="finalScore"></p>
            <p id="xpGained" class="xp-gain"></p>
            <button id="backToDashboardBtn" class="main-btn">ุงูุนูุฏุฉ ุฅูู ููุญุฉ ุงูุชุญูู</button>
        </div>
    </div>

    <!-- ุชุญููู ูููุงุช JavaScript ุจุงูุชุฑุชูุจ ุงูุตุญูุญ -->
    <script src="gamification.js"></script>
    <script src="challenges.js"></script>
    <script src="gems_system.js"></script>
    <script src="new_question_types.js"></script>
    <script src="main.js"></script>
    
    <script>
        // ุชููุฆุฉ ุงููุชุฌุฑ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            // ุฑุจุท ุฃุญุฏุงุซ ุชุจููุจุงุช ุงููุชุฌุฑ
            const categoryTabs = document.querySelectorAll('.category-tab');
            categoryTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ุฅุฒุงูุฉ ุงููุฆุฉ ุงููุดุทุฉ ูู ุฌููุน ุงูุชุจููุจุงุช
                    categoryTabs.forEach(t => t.classList.remove('active'));
                    // ุฅุถุงูุฉ ุงููุฆุฉ ุงููุดุทุฉ ููุชุจููุจ ุงููุญุฏุฏ
                    this.classList.add('active');
                    // ุชุตููุฉ ุงูููุชุฌุงุช
                    filterStoreItems(this.dataset.category);
                });
            });
        });
        
        // ุฏุงูุฉ ุชุตููุฉ ููุชุฌุงุช ุงููุชุฌุฑ
        function filterStoreItems(category) {
            const items = document.querySelectorAll('.store-item');
            items.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // ุฏุงูุฉ ุชุญุฏูุซ ูุงุฌูุฉ ุงููุชุฌุฑ
        async function updateStoreUI() {
            const container = document.getElementById('storeItemsContainer');
            if (!container) return;
            
            container.innerHTML = '<p>ุฌุงุฑู ุชุญููู ุงูููุชุฌุงุช...</p>';
            
            try {
                await loadStoreItems();
                await loadUserPurchases();
                
                container.innerHTML = '';
                
                storeItems.forEach(item => {
                    const itemElement = createStoreItemElement(item);
                    container.appendChild(itemElement);
                });
                
                // ุชุทุจูู ุงูุชุตููุฉ ุงูุญุงููุฉ
                const activeTab = document.querySelector('.category-tab.active');
                if (activeTab) {
                    filterStoreItems(activeTab.dataset.category);
                }
                
            } catch (error) {
                container.innerHTML = '<p style="color: red;">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูููุชุฌุงุช</p>';
                console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุชุฌุฑ:', error);
            }
        }
        
        // ุฏุงูุฉ ุฅูุดุงุก ุนูุตุฑ ููุชุฌ ูู ุงููุชุฌุฑ
        function createStoreItemElement(item) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'store-item';
            itemDiv.dataset.category = item.category;
            
            const isPurchased = hasUserPurchased(item.id);
            const canPurchase = !isPurchased || item.type === 'consumable';
            const hasEnoughGems = userGems >= item.price;
            
            itemDiv.innerHTML = `
                <div class="store-item-header">
                    <span class="store-item-icon">${item.icon}</span>
                    <h4 class="store-item-name">${item.name}</h4>
                </div>
                <p class="store-item-description">${item.description}</p>
                <div class="store-item-footer">
                    <span class="store-item-price">${item.price} ๐</span>
                    <button class="store-item-btn ${!canPurchase ? 'purchased' : !hasEnoughGems ? 'insufficient' : ''}" 
                            onclick="handlePurchase('${item.id}')"
                            ${!canPurchase || !hasEnoughGems ? 'disabled' : ''}>
                        ${!canPurchase ? 'ููุดุชุฑู' : !hasEnoughGems ? 'ุฌูุงูุฑ ุบูุฑ ูุงููุฉ' : 'ุดุฑุงุก'}
                    </button>
                </div>
            `;
            
            return itemDiv;
        }
        
        // ุฏุงูุฉ ุงูุชุนุงูู ูุน ุงูุดุฑุงุก
        async function handlePurchase(itemId) {
            const success = await purchaseItem(itemId);
            if (success) {
                updateStoreUI(); // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุชุฌุฑ
                updateGamificationUI(currentUser); // ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู
            }
        }
    </script>
</body>
</html>

