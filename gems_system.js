// gems_system.js - ูุธุงู ุฅุฏุงุฑุฉ ุงูุฌูุงูุฑ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ

/**
 * ุฏูุงู ุฅุฏุงุฑุฉ ุงูุฌูุงูุฑ ูุงููุชุฌุฑ
 * ูุฌุจ ุชุถููู ูุฐุง ุงูููู ูู HTML ุจุนุฏ main.js
 */

// === ูุชุบูุฑุงุช ุนุงูุฉ ===
let userGems = 0;
let storeItems = [];
let userPurchases = [];

// === ุฏูุงู ุฅุฏุงุฑุฉ ุงูุฌูุงูุฑ ===

/**
 * ุฅุถุงูุฉ ุฌูุงูุฑ ูููุณุชุฎุฏู ุงูุญุงูู
 * @param {number} amount - ุนุฏุฏ ุงูุฌูุงูุฑ ุงููุฑุงุฏ ุฅุถุงูุชูุง
 * @param {string} reason - ุณุจุจ ุงูุญุตูู ุนูู ุงูุฌูุงูุฑ
 */
async function addGems(amount, reason = 'ุงุฎุชุจุงุฑ ูุซุงูู') {
    if (!currentUser || amount <= 0) return false;
    
    try {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', 'addGems');
        url.searchParams.append('userId', currentUser.userId);
        url.searchParams.append('amount', amount);
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            userGems = result.data.newTotal;
            currentUser.gems = userGems;
            updateGemsUI();
            
            // ุนุฑุถ ุฑุณุงูุฉ ุชููุฆุฉ
            showGemsNotification(amount, reason);
            
            return true;
        } else {
            console.error('ูุดู ูู ุฅุถุงูุฉ ุงูุฌูุงูุฑ:', result.error);
            return false;
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุฌูุงูุฑ:', error);
        return false;
    }
}

/**
 * ุฎุตู ุฌูุงูุฑ ูู ุงููุณุชุฎุฏู
 * @param {number} amount - ุนุฏุฏ ุงูุฌูุงูุฑ ุงููุฑุงุฏ ุฎุตููุง
 */
async function spendGems(amount) {
    if (!currentUser || amount <= 0) return false;
    
    try {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', 'spendGems');
        url.searchParams.append('userId', currentUser.userId);
        url.searchParams.append('amount', amount);
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            userGems = result.data.newTotal;
            currentUser.gems = userGems;
            updateGemsUI();
            return true;
        } else {
            alert(result.error);
            return false;
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฎุตู ุงูุฌูุงูุฑ:', error);
        return false;
    }
}

/**
 * ุงูุญุตูู ุนูู ุฑุตูุฏ ุงูุฌูุงูุฑ ุงูุญุงูู
 */
async function getGemsBalance() {
    if (!currentUser) return 0;
    
    try {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', 'getGemsBalance');
        url.searchParams.append('userId', currentUser.userId);
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            userGems = result.data.gems;
            return userGems;
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฌูุจ ุฑุตูุฏ ุงูุฌูุงูุฑ:', error);
    }
    
    return 0;
}

// === ุฏูุงู ูุงุฌูุฉ ุงููุณุชุฎุฏู ููุฌูุงูุฑ ===

/**
 * ุชุญุฏูุซ ุนุฑุถ ุงูุฌูุงูุฑ ูู ุงููุงุฌูุฉ
 */
function updateGemsUI() {
    const gemsElements = document.querySelectorAll('.user-gems');
    gemsElements.forEach(element => {
        element.textContent = userGems;
    });
    
    // ุชุญุฏูุซ ุนุฑุถ ุงูุฌูุงูุฑ ูู ููุญุฉ ุงูุชุญูู ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
    const gemsDisplay = document.getElementById('userGems');
    if (gemsDisplay) {
        gemsDisplay.textContent = `${userGems} ๐`;
    }
}

/**
 * ุนุฑุถ ุฅุดุนุงุฑ ุงูุญุตูู ุนูู ุฌูุงูุฑ
 * @param {number} amount - ุนุฏุฏ ุงูุฌูุงูุฑ ุงูููุชุณุจุฉ
 * @param {string} reason - ุณุจุจ ุงูุญุตูู ุนูู ุงูุฌูุงูุฑ
 */
function showGemsNotification(amount, reason) {
    // ุฅูุดุงุก ุนูุตุฑ ุงูุฅุดุนุงุฑ
    const notification = document.createElement('div');
    notification.className = 'gems-notification';
    notification.innerHTML = `
        <div class="gems-notification-content">
            <span class="gems-icon">๐</span>
            <span class="gems-text">+${amount} ุฌููุฑุฉ</span>
            <span class="gems-reason">${reason}</span>
        </div>
    `;
    
    // ุฅุถุงูุฉ ุงูุฃููุงุท
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #333;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        z-index: 1000;
        animation: slideInRight 0.5s ease-out;
        font-weight: bold;
        border: 2px solid #ffc107;
    `;
    
    // ุฅุถุงูุฉ ุงูุฅุดุนุงุฑ ุฅูู ุงูุตูุญุฉ
    document.body.appendChild(notification);
    
    // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุจุนุฏ 3 ุซูุงู
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.5s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 3000);
}

// === ุฏูุงู ุงููุชุฌุฑ ===

/**
 * ุฌูุจ ููุชุฌุงุช ุงููุชุฌุฑ
 */
async function loadStoreItems() {
    try {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', 'getStoreItems');
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            storeItems = result.data;
            return storeItems;
        } else {
            console.error('ูุดู ูู ุฌูุจ ููุชุฌุงุช ุงููุชุฌุฑ:', result.error);
            return [];
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฌูุจ ููุชุฌุงุช ุงููุชุฌุฑ:', error);
        return [];
    }
}

/**
 * ุฌูุจ ูุดุชุฑูุงุช ุงููุณุชุฎุฏู
 */
async function loadUserPurchases() {
    if (!currentUser) return [];
    
    try {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', 'getUserPurchases');
        url.searchParams.append('userId', currentUser.userId);
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            userPurchases = result.data;
            return userPurchases;
        } else {
            console.error('ูุดู ูู ุฌูุจ ูุดุชุฑูุงุช ุงููุณุชุฎุฏู:', result.error);
            return [];
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฌูุจ ูุดุชุฑูุงุช ุงููุณุชุฎุฏู:', error);
        return [];
    }
}

/**
 * ุดุฑุงุก ููุชุฌ ูู ุงููุชุฌุฑ
 * @param {string} itemId - ูุนุฑู ุงูููุชุฌ
 */
async function purchaseItem(itemId) {
    if (!currentUser) {
        alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
        return false;
    }
    
    const item = storeItems.find(item => item.id === itemId);
    if (!item) {
        alert('ุงูููุชุฌ ุบูุฑ ููุฌูุฏ');
        return false;
    }
    
    // ุงูุชุฃูุฏ ูู ุงูุดุฑุงุก
    const confirmPurchase = confirm(
        `ูู ุชุฑูุฏ ุดุฑุงุก "${item.name}" ููุงุจู ${item.price} ุฌููุฑุฉุ\n\n${item.description}`
    );
    
    if (!confirmPurchase) return false;
    
    try {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', 'purchaseItem');
        url.searchParams.append('userId', currentUser.userId);
        url.searchParams.append('itemId', itemId);
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            userGems = result.data.newGemsBalance;
            currentUser.gems = userGems;
            
            // ุฅุถุงูุฉ ุงูููุชุฌ ุฅูู ูุงุฆูุฉ ุงููุดุชุฑูุงุช
            userPurchases.push(result.data.purchaseRecord);
            
            // ุชุญุฏูุซ ุงููุงุฌูุฉ
            updateGemsUI();
            updateStoreUI();
            
            alert(`ุชู ุดุฑุงุก "${item.name}" ุจูุฌุงุญ! ๐`);
            return true;
        } else {
            alert(result.error);
            return false;
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุดุฑุงุก ุงูููุชุฌ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุดุฑุงุก. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
        return false;
    }
}

/**
 * ุงูุชุญูู ูู ููููุฉ ุงููุณุชุฎุฏู ูููุชุฌ ูุนูู
 * @param {string} itemId - ูุนุฑู ุงูููุชุฌ
 */
function hasUserPurchased(itemId) {
    return userPurchases.some(purchase => purchase.itemId === itemId);
}

/**
 * ุงูุญุตูู ุนูู ุงูููุชุฌุงุช ุงููุดุชุฑุงุฉ ูู ูุฆุฉ ูุนููุฉ
 * @param {string} category - ูุฆุฉ ุงูููุชุฌุงุช
 */
function getPurchasedItemsByCategory(category) {
    return userPurchases
        .filter(purchase => {
            const item = storeItems.find(item => item.id === purchase.itemId);
            return item && item.category === category;
        })
        .map(purchase => {
            const item = storeItems.find(item => item.id === purchase.itemId);
            return { ...item, purchaseDate: purchase.purchaseDate };
        });
}

// === ุฏูุงู ูุญุต ุงูุฌูุงูุฑ ุจุนุฏ ุงูุงุฎุชุจุงุฑุงุช ===

/**
 * ูุญุต ุงุณุชุญูุงู ุงูุฌูุงูุฑ ุจุนุฏ ุงูุชูุงุก ุงูุงุฎุชุจุงุฑ
 * @param {number} score - ุงููุชูุฌุฉ ุงููุญููุฉ
 * @param {number} totalQuestions - ุฅุฌูุงูู ุงูุฃุณุฆูุฉ
 * @param {boolean} isPerfectStreak - ูู ูุฐุง ุฌุฒุก ูู ุณูุณูุฉ ูุฌุงุญ ูุซุงููุฉ
 */
async function checkGemsReward(score, totalQuestions, isPerfectStreak = false) {
    let gemsEarned = 0;
    let reason = '';
    
    // ุฌููุฑุฉ ูุงุญุฏุฉ ููุงุฎุชุจุงุฑ ุงููุซุงูู (100%)
    if (score === totalQuestions) {
        gemsEarned += 1;
        reason = 'ุงุฎุชุจุงุฑ ูุซุงูู 100%';
        
        // ููุงูุฃุฉ ุฅุถุงููุฉ ูุณูุณูุฉ ุงููุฌุงุญ
        if (isPerfectStreak) {
            gemsEarned += 1;
            reason = 'ุงุฎุชุจุงุฑ ูุซุงูู + ุณูุณูุฉ ูุฌุงุญ';
        }
    }
    
    // ุฅุถุงูุฉ ุงูุฌูุงูุฑ ุฅุฐุง ูุงู ููุงู ุงุณุชุญูุงู
    if (gemsEarned > 0) {
        await addGems(gemsEarned, reason);
        return gemsEarned;
    }
    
    return 0;
}

// === ุชููุฆุฉ ุงููุธุงู ===

/**
 * ุชููุฆุฉ ูุธุงู ุงูุฌูุงูุฑ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
 */
async function initializeGemsSystem() {
    if (currentUser) {
        userGems = currentUser.gems || 0;
        await loadStoreItems();
        await loadUserPurchases();
        updateGemsUI();
    }
}

// === ุฅุถุงูุฉ ุงูุฃููุงุท CSS ููุฅุดุนุงุฑุงุช ===
const gemsStyles = document.createElement('style');
gemsStyles.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .gems-notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .gems-icon {
        font-size: 20px;
    }
    
    .gems-text {
        font-size: 16px;
        font-weight: bold;
    }
    
    .gems-reason {
        font-size: 12px;
        opacity: 0.8;
    }
`;

document.head.appendChild(gemsStyles);

